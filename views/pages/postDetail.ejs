<!DOCTYPE html>
<html lang="en">
<%- include('../partials/head') %>
<style>
    /* Mention Suggestion Box Style */
    .suggestion-box {
        position: absolute;
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 8px;
        width: 200px;
        max-height: 150px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
    }
    .suggestion-item {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 12px;
        color: #cbd5e1;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .suggestion-item:hover { background: #3b82f6; color: white; }
    .suggestion-item .avatar {
        width: 20px; height: 20px; border-radius: 50%; background: #475569;
        display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 10px;
    }
</style>

<body class="bg-[#0F172A] text-slate-200 min-h-screen flex font-sans">
    <%- include('../partials/sidebar') %>
    <main class="ml-64 flex-1 p-8">
        <div class="max-w-4xl mx-auto">
            <button onclick="history.back()" class="flex items-center space-x-2 text-slate-400 hover:text-white mb-6">
                <i class="ri-arrow-left-line"></i><span>Back</span>
            </button>

            <div class="bg-slate-900/50 border border-slate-800 p-8 rounded-3xl shadow-2xl mb-10">
                <div class="flex justify-between items-start mb-6">
                    <div>
                         <span class="text-xs font-bold text-blue-400 bg-blue-500/10 px-3 py-1 rounded-full uppercase tracking-wider"><%= idea.category %></span>
                         <h1 class="text-4xl font-bold text-white mt-4 mb-2"><%= idea.title %></h1>
                         <div class="flex items-center gap-2 text-slate-500 text-sm">
                             <span>By <a href="/user/<%= idea.authorId %>" class="text-blue-400 hover:underline"><%= idea.author %></a></span>
                         </div>
                    </div>
                </div>
                
                <% if(idea.images && idea.images.length > 0) { %>
                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <% idea.images.forEach(img => { %>
                            <img src="<%= img.src %>" class="w-full h-64 object-cover rounded-xl border border-slate-700">
                        <% }) %>
                    </div>
                <% } %>

                <p class="text-slate-300 text-lg leading-relaxed whitespace-pre-line mb-10"><%= idea.description %></p>
                <div class="flex items-center gap-6 border-t border-slate-800 pt-6">
                    <a href="/post/<%= idea._id %>/raise" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 rounded-xl transition">
                        <i class="ri-arrow-up-circle-fill text-xl text-green-400"></i> <span class="font-bold">Raise Idea (<%= idea.upvotes.length %>)</span>
                    </a>
                </div>
            </div>

            <div class="mt-10 relative">
                <h3 class="text-2xl font-bold text-white mb-6">Comments (<%= idea.comments.length %>)</h3>
                
                <form action="/post/<%= idea._id %>/comment" method="POST" class="mb-8 relative">
                    <textarea id="mainCommentBox" name="comment" rows="3" class="w-full bg-slate-900 border border-slate-800 rounded-xl p-4 text-white focus:border-blue-500 outline-none placeholder-slate-600" placeholder="Type @ to mention someone..." onkeyup="handleMention(event, this)"></textarea>
                    
                    <div id="suggestionBox" class="suggestion-box"></div>

                    <button type="submit" class="mt-3 bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold">Post Comment</button>
                </form>

                <div class="space-y-6">
                    <% idea.comments.forEach(comment => { %>
                        <div class="bg-slate-900/50 p-6 rounded-2xl border border-slate-800">
                            <div class="flex items-center gap-3 mb-3">
                                <a href="/user/<%= comment.userId %>" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold text-white hover:bg-blue-600 transition"><%= comment.user.charAt(0) %></a>
                                <div>
                                    <a href="/user/<%= comment.userId %>" class="font-bold text-slate-300 text-sm hover:text-blue-400 transition"><%= comment.user %></a>
                                    <span class="text-xs text-slate-600 ml-2"><%= comment.createdAt.toLocaleDateString() %></span>
                                </div>
                            </div>
                            
                            <p class="text-slate-400 text-sm ml-11 mb-3">
                                <%- comment.text.replace(/@(\w+)/g, '<a href="/api/users/search?find=$1" class="text-blue-400 hover:underline font-bold">@$1</a>') %>
                            </p>
                            
                            <% if (comment.replies && comment.replies.length > 0) { %>
                                <div class="ml-11 mt-3 space-y-3 pl-4 border-l-2 border-slate-700">
                                    <% comment.replies.forEach(reply => { %>
                                        <div class="bg-slate-900/80 p-3 rounded-lg group">
                                            <div class="flex justify-between items-start">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <a href="/user/<%= reply.userId %>" class="font-bold text-blue-400 text-xs hover:underline"><%= reply.user %></a>
                                                </div>
                                                <button onclick="replyToUser('<%= comment._id %>', '<%= reply.user %>')" class="text-[10px] text-slate-500 hover:text-white opacity-0 group-hover:opacity-100 transition px-2 py-1 bg-slate-800 rounded">Reply</button>
                                            </div>
                                            <p class="text-slate-500 text-xs">
                                                <%- reply.text.replace(/@(\w+)/g, '<a href="/api/users/search?find=$1" class="text-blue-400 hover:underline font-bold">@$1</a>') %>
                                            </p>
                                        </div>
                                    <% }) %>
                                </div>
                            <% } %>

                            <div class="ml-11 mt-2">
                                <details id="details-<%= comment._id %>">
                                    <summary class="text-xs text-blue-500 cursor-pointer font-bold hover:underline w-fit">Reply</summary>
                                    <form action="/post/<%= idea._id %>/comment/<%= comment._id %>/reply" method="POST" class="mt-2 flex gap-2 relative">
                                        <input type="text" id="input-<%= comment._id %>" name="reply" placeholder="Write a reply..." class="bg-slate-900 border border-slate-700 text-xs text-white rounded-lg px-3 py-2 w-full focus:outline-none focus:border-blue-500" onkeyup="handleMention(event, this)">
                                        <button type="submit" class="bg-blue-600 text-white text-xs px-3 py-2 rounded-lg font-bold">Send</button>
                                    </form>
                                </details>
                            </div>
                        </div>
                    <% }) %>
                </div>
            </div>
        </div>
    </main>
    <%- include('../partials/postModal') %>

    <script>
        let currentInput = null;
        const box = document.getElementById('suggestionBox');

        async function handleMention(e, input) {
            currentInput = input;
            const val = input.value;
            const lastWord = val.split(' ').pop();

            // Check if typing @name
            if (lastWord.startsWith('@') && lastWord.length > 1) {
                const query = lastWord.substring(1); 
                
                // Fetch Users from API
                const res = await fetch(`/api/users/search?q=${query}`);
                const users = await res.json();

                if (users.length > 0) {
                    // Position Box
                    box.style.left = (input.offsetLeft + 20) + 'px'; 
                    box.style.top = (input.offsetTop + input.offsetHeight) + 'px';
                    
                    // Render List
                    box.innerHTML = users.map(u => `
                        <div class="suggestion-item" onclick="selectUser('${u.displayName}')">
                            <div class="avatar">${u.displayName.charAt(0)}</div>
                            <span>${u.displayName}</span>
                        </div>
                    `).join('');
                    
                    // Append near input
                    input.parentNode.appendChild(box); 
                    box.style.display = 'block';
                } else {
                    box.style.display = 'none';
                }
            } else {
                box.style.display = 'none';
            }
        }

        function selectUser(name) {
            const val = currentInput.value;
            const words = val.split(' ');
            words.pop(); // Remove partial
            words.push(`@${name} `); // Add full mention
            currentInput.value = words.join(' ');
            box.style.display = 'none';
            currentInput.focus();
        }

        // Hide box on click outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.suggestion-box')) box.style.display = 'none';
        });

        // Reply Button Logic
        function replyToUser(commentId, username) {
            const details = document.getElementById(`details-${commentId}`);
            if(details) details.open = true;
            const input = document.getElementById(`input-${commentId}`);
            if(input) {
                input.value = `@${username} `;
                input.focus();
            }
        }
    </script>
</body>
</html>